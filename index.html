<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teleprompter Pro 5.0</title>
    <style>
        /* Estilo Geral */
        body { margin: 0; background-color: #000; color: white; font-family: 'Segoe UI', Arial, sans-serif; overflow: hidden; }
        
        /* Menu de Configura√ß√£o */
        #setup-panel {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #121212; z-index: 20; padding: 20px; box-sizing: border-box;
            display: flex; flex-direction: column; gap: 15px; overflow-y: auto;
        }
        
        h2 { color: #fff; margin-bottom: 5px; font-size: 1.4rem; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        textarea {
            width: 100%; height: 120px; background: #222; color: #eee;
            border: 1px solid #444; padding: 15px; font-size: 16px; border-radius: 8px;
            resize: vertical; font-family: monospace;
        }
        
        .section-box {
            background: #1e1e1e; border-radius: 8px; padding: 15px;
            border: 1px solid #333;
        }

        .controls-row {
            display: flex; flex-wrap: wrap; gap: 20px; align-items: center;
        }
        
        .control-item { display: flex; flex-direction: column; gap: 5px; flex: 1; }
        
        label { color: #aaa; font-size: 13px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        
        input[type="number"] { 
            padding: 12px; background: #333; color: white; border: 1px solid #555; 
            border-radius: 4px; font-size: 18px; width: 100%; box-sizing: border-box;
        }

        /* Checkboxes e Voz */
        .checkbox-label {
            display: flex; align-items: center; gap: 10px; cursor: pointer;
            font-size: 16px; color: #fff; text-transform: none;
        }
        input[type="checkbox"] { transform: scale(1.5); margin: 0; }

        /* Bot√µes Principais */
        .action-buttons {
            display: flex; gap: 10px; margin-top: 10px; margin-bottom: 30px;
        }

        .btn {
            padding: 15px; border: none; border-radius: 8px; cursor: pointer; 
            font-size: 16px; font-weight: bold; flex: 1; text-transform: uppercase;
            transition: opacity 0.2s;
        }
        .btn:active { opacity: 0.8; transform: scale(0.98); }

        .btn-fullscreen { background: #17a2b8; color: white; flex: 0.4; } /* Bot√£o menor */
        .btn-start { background: #28a745; color: white; flex: 1; }     /* Bot√£o maior */

        /* Indicador de Status do Mic */
        #mic-status-light {
            display: inline-block; width: 10px; height: 10px; border-radius: 50%;
            background: #444; margin-left: auto;
        }
        
        /* √Årea do Teleprompter */
        #prompter-window {
            display: none; width: 100%; height: 100vh; position: relative;
            background: black; overflow: hidden;
        }

        #scrolling-content {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            overflow-y: auto; padding: 0 20px;
            -ms-overflow-style: none; scrollbar-width: none;
        }
        #scrolling-content::-webkit-scrollbar { display: none; }
        
        #text-display {
            padding-top: 35vh; /* Linha vermelha est√° em 30%, texto come√ßa um pouco abaixo */
            padding-bottom: 100vh;
            font-size: 60px; line-height: 1.4; text-align: center;
            font-weight: bold; margin: 0 auto; max-width: 90%;
        }

        /* Espelhamento */
        .mirror-x { transform: scaleX(-1); }
        .mirror-y { transform: scaleY(-1); }
        .mirror-xy { transform: scale(-1, -1); }

        /* Controles Flutuantes */
        #overlay-controls {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: linear-gradient(to top, rgba(0,0,0,1), rgba(0,0,0,0));
            padding: 30px 20px;
            display: none; justify-content: center; gap: 20px;
            z-index: 100;
        }

        .btn-control {
            padding: 15px 30px; font-size: 18px; border: none; border-radius: 50px;
            cursor: pointer; font-weight: bold; min-width: 120px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .btn-pause { background: #ffc107; color: #000; }
        .btn-stop { background: #dc3545; color: white; }

        /* HUD de Voz durante a leitura */
        #voice-hud {
            position: fixed; top: 20px; right: 20px; 
            background: rgba(0,0,0,0.7); border: 1px solid #555;
            padding: 8px 15px; border-radius: 20px; 
            font-size: 14px; color: #aaa; display: none; z-index: 101;
        }
        .hud-active { color: #0f0 !important; border-color: #0f0 !important; }
        .hud-waiting { color: #ff0 !important; border-color: #ff0 !important; }

        /* Marcador Central (Linha Vermelha) */
        #center-marker {
            position: fixed; top: 30%; left: 0; width: 100%; height: 2px;
            background: rgba(255, 0, 0, 0.6); 
            box-shadow: 0 0 8px rgba(255,0,0,0.8);
            z-index: 50; pointer-events: none;
            display: none;
        }
        #center-marker::before, #center-marker::after {
            content: "‚ñ≤"; color: rgba(255,0,0,0.8); font-size: 14px;
            position: absolute; top: -6px;
        }
        #center-marker::before { left: 5px; transform: rotate(90deg); }
        #center-marker::after { right: 5px; transform: rotate(-90deg); }

    </style>
</head>
<body>

    <div id="setup-panel">
        <h2>Teleprompter Studio</h2>
        
        <textarea id="input-text" placeholder="Cole seu roteiro aqui...">Este √© o texto de teste.
Ao ativar o microfone abaixo, o navegador pedir√° permiss√£o.
Voc√™ deve permitir para que a rolagem por voz funcione.
Fale para rolar. Fique em sil√™ncio para pausar.</textarea>
        
        <div class="section-box">
            <div class="controls-row">
                <div class="control-item">
                    <label>Tamanho (px)</label>
                    <input type="number" id="font-size" value="60">
                </div>
                <div class="control-item">
                    <label>Velocidade (WPM)</label>
                    <input type="number" id="wpm-speed" value="140">
                </div>
            </div>
        </div>

        <div class="section-box" style="border-color: #007bff;">
            <label class="checkbox-label">
                <input type="checkbox" id="check-voice" onchange="toggleVoicePermission(this)"> 
                üéôÔ∏è Ativar Controle por Voz
                <span id="mic-status-light"></span>
            </label>
            <div style="font-size: 12px; color: #888; margin-top: 5px; margin-left: 30px;">
                Ao marcar, permita o acesso ao microfone.
            </div>
        </div>

        <div class="section-box">
            <div class="controls-row">
                <label class="checkbox-label">
                    <input type="checkbox" id="check-mirror-x"> Espelhar Horizontal
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="check-mirror-y"> Espelhar Vertical
                </label>
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn btn-fullscreen" onclick="toggleFullScreen()">‚õ∂ TELA CHEIA</button>
            <button class="btn btn-start" onclick="startPrompter()">INICIAR ‚ñ∂</button>
        </div>
        
        <div style="text-align: center; color: #444; font-size: 12px; margin-top: 20px;">
            v5.0 - GitHub Version
        </div>
    </div>

    <div id="prompter-window">
        <div id="voice-hud">üéôÔ∏è Aguardando voz...</div>
        <div id="scrolling-content">
            <div id="text-display"></div>
        </div>
        <div id="center-marker"></div>
    </div>
    
    <div id="overlay-controls">
        <button id="btn-toggle" class="btn-control btn-pause" onclick="togglePauseManual()">PAUSAR ‚è∏</button>
        <button class="btn-control btn-stop" onclick="stopPrompter()">SAIR ‚èπ</button>
    </div>

    <script>
        let scrollInterval = null;
        let currentScroll = 0;
        let isPaused = false;
        let pixelsPerTick = 0;
        let scroller;
        
        // Vari√°veis de Voz
        let audioContext;
        let analyser;
        let microphoneStream = null;
        let silenceTimer = null;
        let voiceEnabled = false;

        // --- FUN√á√ÉO 1: PEDIR PERMISS√ÉO DO MICROFONE (IMEDIATO) ---
        async function toggleVoicePermission(checkbox) {
            const light = document.getElementById('mic-status-light');
            
            if (checkbox.checked) {
                try {
                    // Pede permiss√£o AGORA, no momento do clique
                    microphoneStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    // Sucesso
                    light.style.background = "#0f0"; // Verde
                    voiceEnabled = true;
                    
                } catch (err) {
                    // Erro ou Negado
                    console.error(err);
                    alert("‚ö†Ô∏è Permiss√£o de microfone negada ou indispon√≠vel.\nVerifique as configura√ß√µes do navegador ou se o site est√° em HTTPS.");
                    checkbox.checked = false;
                    voiceEnabled = false;
                    light.style.background = "#f00"; // Vermelho
                }
            } else {
                // Desligar
                voiceEnabled = false;
                light.style.background = "#444";
                if (microphoneStream) {
                    microphoneStream.getTracks().forEach(track => track.stop());
                    microphoneStream = null;
                }
            }
        }

        // --- FUN√á√ÉO 2: TELA CHEIA (INDEPENDENTE) ---
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    alert(`Erro ao tentar tela cheia: ${err.message}`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        // --- FUN√á√ÉO 3: INICIAR O PROMPTER ---
        function startPrompter() {
            const text = document.getElementById('input-text').value;
            const fontSize = document.getElementById('font-size').value;
            const wpm = parseInt(document.getElementById('wpm-speed').value) || 100;
            const mirrorX = document.getElementById('check-mirror-x').checked;
            const mirrorY = document.getElementById('check-mirror-y').checked;

            if (!text.trim()) return alert("Digite o texto do roteiro!");

            // Configurar UI
            const setupPanel = document.getElementById('setup-panel');
            const prompterWindow = document.getElementById('prompter-window');
            const textBox = document.getElementById('text-display');
            scroller = document.getElementById('scrolling-content');
            
            // Inserir Texto
            textBox.innerHTML = text.replace(/\n/g, "<br>");
            textBox.style.fontSize = fontSize + "px";

            // Espelhamento
            prompterWindow.className = "";
            if (mirrorX && mirrorY) prompterWindow.classList.add('mirror-xy');
            else if (mirrorX) prompterWindow.classList.add('mirror-x');
            else if (mirrorY) prompterWindow.classList.add('mirror-y');

            // Trocar Telas
            setupPanel.style.display = 'none';
            prompterWindow.style.display = 'block';
            document.getElementById('overlay-controls').style.display = 'flex';
            document.getElementById('center-marker').style.display = 'block';

            // Resetar
            scroller.scrollTop = 0;
            currentScroll = 0;

            // Se voz estiver ativa, configuramos o AudioContext agora usando o stream j√° obtido
            if (voiceEnabled && microphoneStream) {
                initAudioAnalysis();
                isPaused = true; // Come√ßa pausado esperando voz
                document.getElementById('btn-toggle').style.display = 'none'; // Esconde bot√£o manual
                document.getElementById('voice-hud').style.display = 'block';
            } else {
                isPaused = false; // Come√ßa rodando direto
                document.getElementById('btn-toggle').style.display = 'block';
                document.getElementById('voice-hud').style.display = 'none';
                updatePauseButtonUI();
            }

            // C√°lculo WPM e Loop de Scroll
            setTimeout(() => {
                const wordCount = text.trim().split(/\s+/).length;
                const totalMinutes = wordCount / wpm;
                const contentHeight = textBox.scrollHeight; 
                const pixelsPerSecond = contentHeight / (totalMinutes * 60);
                const intervalTime = 20; 
                pixelsPerTick = pixelsPerSecond * (intervalTime / 1000);

                if (scrollInterval) clearInterval(scrollInterval);
                scrollInterval = setInterval(autoScroll, intervalTime);
            }, 500);
        }

        function autoScroll() {
            if (!isPaused && scroller) {
                currentScroll += pixelsPerTick;
                scroller.scrollTop = currentScroll;
            }
        }

        // --- L√ìGICA DE DETEC√á√ÉO DE VOZ ---
        function initAudioAnalysis() {
            // Cria o contexto de √°udio
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const source = audioContext.createMediaStreamSource(microphoneStream);
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;
            source.connect(analyser);

            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            const hud = document.getElementById('voice-hud');

            function detectLoop() {
                if (!voiceEnabled || document.getElementById('prompter-window').style.display === 'none') return;

                analyser.getByteFrequencyData(dataArray);
                
                // M√©dia de volume
                let sum = 0;
                for(let i = 0; i < dataArray.length; i++) sum += dataArray[i];
                let average = sum / dataArray.length;

                // LIMIAR DE VOZ (Ajuste se necess√°rio: 10 √© sens√≠vel, 20 exige fala mais alta)
                const threshold = 10; 

                if (average > threshold) {
                    // VOZ DETECTADA
                    if (silenceTimer) { clearTimeout(silenceTimer); silenceTimer = null; }
                    
                    if (isPaused) {
                        isPaused = false;
                        hud.innerText = "üó£Ô∏è Ouvindo...";
                        hud.className = "hud-active";
                    }
                } else {
                    // SIL√äNCIO
                    if (!isPaused && !silenceTimer) {
                        hud.innerText = "‚è≥ ..."; // Aviso visual r√°pido
                        silenceTimer = setTimeout(() => {
                            isPaused = true;
                            hud.innerText = "‚è∏Ô∏è Pausa (Sil√™ncio)";
                            hud.className = "hud-waiting";
                        }, 2000); // 2 segundos de toler√¢ncia
                    }
                }
                requestAnimationFrame(detectLoop);
            }
            detectLoop();
        }

        // --- FUN√á√ïES DE CONTROLE ---
        function togglePauseManual() {
            isPaused = !isPaused;
            updatePauseButtonUI();
        }

        function updatePauseButtonUI() {
            const btn = document.getElementById('btn-toggle');
            if (isPaused) {
                btn.innerText = "CONTINUAR ‚ñ∂";
                btn.style.backgroundColor = "#28a745";
                btn.style.color = "white";
            } else {
                btn.innerText = "PAUSAR ‚è∏";
                btn.style.backgroundColor = "#ffc107"; 
                btn.style.color = "black";
            }
        }

        function stopPrompter() {
            clearInterval(scrollInterval);
            document.getElementById('prompter-window').style.display = 'none';
            document.getElementById('overlay-controls').style.display = 'none';
            document.getElementById('setup-panel').style.display = 'flex';
            
            // Se estiver em fullscreen, pode querer sair ou n√£o.
            // Geralmente mantemos se o usu√°rio clicou no bot√£o fullscreen separado.
        }
        
        // Clique na tela para pausa manual r√°pida (se n√£o for voz)
        document.getElementById('prompter-window').addEventListener('click', () => {
             if (!voiceEnabled) togglePauseManual();
        });
    </script>
</body>
</html>
